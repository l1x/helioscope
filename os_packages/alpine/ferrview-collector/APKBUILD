# Contributor:
# Maintainer:
pkgname=ferrview-collector
pkgver=0.3.0
pkgrel=0
pkgdesc="A lightweight system monitoring collector - collector server component"
url="https://github.com/l1x/ferrview"
arch="all"
license="AGPL-3.0"
depends="sqlite-libs"
makedepends="cargo cargo-auditable sqlite-dev"
checkdepends=""
install="$pkgname.pre-install $pkgname.post-install"
subpackages="$pkgname-openrc"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/l1x/ferrview/archive/refs/tags/v$pkgver.tar.gz
	ferrview-collector.initd
	ferrview-collector.confd
	"
builddir="$srcdir/ferrview-$pkgver"
options="net" # needed for cargo to fetch dependencies

build() {
	cargo auditable build --release --locked \
		--package ferrview-collector
}

check() {
	cargo test --release --locked \
		--package ferrview-collector
}

package() {
	install -Dm755 target/release/ferrview-collector \
		"$pkgdir"/usr/sbin/ferrview-collector

	install -m755 -D "$srcdir"/ferrview-collector.initd \
		"$pkgdir"/etc/init.d/ferrview-collector
	install -m644 -D "$srcdir"/ferrview-collector.confd \
		"$pkgdir"/etc/conf.d/ferrview-collector

	install -dm755 "$pkgdir"/etc/ferrview
	install -Dm644 ferrview-collector/ferrview-collector.toml \
		"$pkgdir"/etc/ferrview/ferrview-collector.toml.example

	install -dm750 -o ferrview -g ferrview \
		"$pkgdir"/var/lib/ferrview
}

sha512sums="
e490c79421f532f894bd69fc2b44aeeab10d856dc0848d4679b3fa9cf2939e0501727c8a2c7ae8b850a8eed3de0adc41e9b6315c767bc0b77489171cd52d3e92  ferrview-collector.initd
74fd6d07fb26ff43b257e8b914facdc220d3d84956adfb7bb302e5b65d718967dacb76133b59fde77855c5c94eada88292dd3cc9b80be3e14a570c96490e7080  ferrview-collector.confd
"
